---
title: "언두 데이터"
categories: 
  - Oracle
last_modified_at: 2019-01-02T22:00:00+09:00
toc: true
---

# 1. 언두데이터의 개념
```
언두 데이터: DML이 발생할 경우 변경되기 전의 데이터 값
언두 세그먼트: 언두 데이터를 저장하는 세그먼트
언두 테이블스페이스 : 언두 세그먼트를 저장하는 테이블스페이스
```

# 2. 언두데이터의 목적
> 언두 데이터는 3가지의 목적으로 사용한다

| 목적 | 내용 |
|---|:----------|
| **Transaction Rollback** | 작업 수행 중이나 후에 커밋을 수행하지 않고 작업을 취소한 경우 |  
| **Read Consistency** | 변경 중인 데이터 또느느 변경된 데이터에 대한 조회 시 정합성 보장 |  
| **Recovery** | 시스템 장애 시 커밋이 수행된 작업까지 복구 |  

## 2.1 Transaction Rollback (작업 롤백)
![Alt text](/assets/images/Undo1.png "Oracle 12c")
### - 개념
```
1. 롤백은 변경전의 데이터로 복구하는 작업을 의미한다.

2. 해당 작업에 대해 커밋을 수행했다면 더 이상 롤백을 수행할 수 없다.

3. 커밋을 하게되면 더 이상 언두 데이터를 사용하지 않게 된다.
```
>> 그림 설명
* 1. 유저에 의해 ①과 같이 변경 작업 수행
* 2. 변경 작업을 수행하기 전에 ②와 같이 롤백을 위해 변경전 데이터인 '서울'을 언두 데이터로 생성하여 언두 세그먼트에 저장
* 3. 변경 작업을 통해 ③과 같이 '서울'을 '분당'으로 변경 수행
* 4. 유저에 의해 ④와 같이 롤백 수행
* 5. 언두 세그먼트에 존재하는 언두 데이터를 ⑤와 같이 부서 테이블에 복구하여 '분당'인 값을 '서울'로 복구

### - 상세
```
```
### - 요약
```
 롤백이란 특정 작업을 수행한 후 커밋을 수행하지 않고 롤백을 수행하게 되면 작업 수행전의 데이터로 복구되는 기능이다. 
```

## 2.2 Read Consistency (읽기 일관성)
![Alt text](/assets/images/undo2.png "Oracle 12c")

### - 개념
```
1. 조회하는 도중에 발생한 변경 데이터에 대해 어떤 데이터를 보여주는 것이 옳은 가에 대한 개념이다.

2. 변경된 데이터는 조회 이후 시점이므로 변경되기 전의 데이터를 결과로 추출하도록 설계 되어 있다. 
```
![Alt text](/assets/images/undo3.png "Oracle 12c")
>> 그림 설명
* 1. ①과 같이 부서 테이블을 **조회**한다.
* 2. (10,DM팀,서울)인 **데이터를 읽어 오기 전에** 다른 변경 프로세스에 의해 ②와 같이 컬럼의 값을 '분당'으로 **변경을 수행**한다.
* 3. **변경 전 데이터**인 '서울'을 ③과 같이 언두 데이터로 생성하여 **언두 세그먼트에 저장**한다.
* 4. ④와 같이 ①에서의 조회 프로세스가 **변경된 데이터에 접근**한다. 
* 5. ②에서의 데이터를 변경한 프로세스가 커밋을 수행하였는지 안 했는지에 따라 결과가 다르게 추출될 수 있다.
* 6. 커밋을 수행 하였다면 ⑥과 같이 둘중 하나의 결과가 추출된다.

### - 상세
```
1.  수행시간이 많이 걸리는 조회 수행 중 조회 대상에 대한 다른 트랜잭션의 변경 작업이 
    일어날 경우 오라클에서는 조회 트랜잭션과 변경 트랜잭션의 SCN을 비교하여
    CR 작업을 통해 원래의 데이터를 보여준다.
```
### - 요약
```
 오라클은 블록 읽기 작업시 기본적으로 CR을 수행한다.
CR은 Consistent Read(일관된 읽기)의 약자로 Query가 시작하는 시점의 SCN과 호환되는 일관된 버전의 데이터, 즉 과거 버전의 데이터를 읽는다는 것을 의미한다.
```

## 2.3 Recovery (복구)
![Alt text](/assets/images/undo4.png "Oracle 12c")
### - 개념
```
1. 트랜잭션 수행 중에 시스템 비정상 종료, 시스템 장애 해결 후 오라클 재기동시에 수행된다. 

2. 복구를 수행하면 언두 세그먼트의 언두 데이터를 이용하여 복구를 수행한다.
```
> 복구의 종류와 언두 데이터와의 관계

| 구분 | 내용 |
|---|:---:|
| **Instance Recovery** | 언두 데이터를 이용 |  
| **Media Recovery** | 언두 데이터 일부 이용 |  

>> 그림 설명
* 1. ①과 같이 **장애 발생 시점 이후의 리두 로그 파일을 적용**한다. 리두 로그 파일 내부에는 커밋된 데이터와 
     커밋되지 않은 데이터가 함께 존재하므로 해당 리두 로그 파일을 적용한 후에 데이터베이스에는 
     장애전 커밋된 데이터뿐만 아니라 커밋되지 않은 데이터도 함께 존재한다.
* 2. ①번 단계에서 리두 로그의 SQL을 실제 수행하므로 ②와 같이 **언두 세그먼트를 재생성**한다.
* 3. ①번 단계를 수행한 후 커밋된 데이터만을 오라클에 저장하기 위해 ③과 같이 재생성 된 언두 세그먼트의 언두 데이터를 이용하여 커밋되지 않은 **데이터를 롤백**한다.
* 4. 언두 세그먼트 적용 후에는 ③과 같이 오라클에는 **커밋된 데이터만 존재한다.**


>> 오라클에서 제공하는 복구 방식은 두가지가 있다.
>> Instance Recovery (인스턴스 복구) 와 Media Recovery (미디어 복구)

| 구분 | 내용 |
|---|:----------------------|
| **Read Consistency** | 시스템 또는 오라클이 비정상 종료한 후 재기동 시 발생하는 복구 방식 으로 앞의 예와 같은 절차를 수행하여 데이터 정합성을 보장한다. |  
| **Recovery** | 실제 디스크 데이터 파일 등에 장애가 발생하여 기존 백업본을 이용하여 복구를 수행하는 경우를 의미한다. |  


### - 상세
```
서버가 비정상 종료가 되면 redo를 이용해 roll forward 단계가 완료 된 후 최종 commit 되지 않은 변경 사항까지 모두 복구한다. 
따라서 시스템이 shutdown 된 시점에 commit 되지 않았던 transaction들을 모두 rollback 해야 하는데, 이때 undo segment에 저장된 undo data를 사용한다.
```
### - 요약
```
 추후 예정
```

# 3. 언두 세그먼트의 개념
## 3.1 언두 세그먼트의 특징

| 항목 | 내용 |
|---|:-------------------|
| **일반 세그먼트와 동일한 구조** | 테이블은 익스텐트로 구성되며 익스텐트는 데이터 블록으로 구성된다. 언두 세그먼트 또한 익스텐트로 구성되며 해당 익스텐트들은 언두 블록으로 구성된다. 
언두 세그먼트 또한 익스텐트로 구성되며 해당 익스텐트들은 언두 블록으로 구성된다. 언두 블록과 데이터 블록은 동일하다. 따라서 물리적으로 일반 세그먼트와 언두 세그먼트는 동일한 구조를 가진다.|  
| **하나의 작업은 하나의 언두 세그먼트를 사용** | 실제 디스크 데이터 파일 등에 장애가 발생하여 기존 백업본을 이용하여 복구를 수행하는 경우를 의미한다. |  